<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Security Detail</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- ag-Grid CSS for version history grid -->
  <link rel="stylesheet" href="https://unpkg.com/ag-grid-community@26.2.0/dist/styles/ag-grid.css">
  <link rel="stylesheet" href="https://unpkg.com/ag-grid-community@26.2.0/dist/styles/ag-theme-alpine.css">
  <style>
    .card-header .row > div { padding: 0 10px; }
    .ag-theme-alpine { height: 300px; width: 100%; }
  </style>
</head>
<body>
<div class="container mt-4">
  {% if record %}
    <!-- Main Detail Card -->
    <div class="card mb-4" id="detailCard">
      <div class="card-header">
        <div class="row">
          <div class="col-md-6">
            <h5><strong>Asset Class:</strong> <span id="detailAssetClass">{{ record.ASSET_CLASS }}</span></h5>
          </div>
          <div class="col-md-6">
            <h5><strong>Asset Group:</strong> <span id="detailAssetGroup">{{ record.ASSET_GROUP }}</span></h5>
          </div>
        </div>
        <div class="mt-2">
          <div class="form-check">
            <input type="checkbox" id="filterValues" class="form-check-input">
            <label for="filterValues" class="form-check-label">Only show fields with values</label>
          </div>
        </div>
      </div>
      <div class="card-body" id="detailBody">
        <table class="table table-striped" id="detailTable">
          <tbody>
            {% for key, value in record.items() %}
            <tr class="detail-row">
              <th style="width: 30%;">{{ key }}</th>
              <td class="value-cell">{{ value }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Version History Card -->
    <div class="card">
      <div class="card-header">
        <h5>Version History</h5>
      </div>
      <div class="card-body">
        <div id="versionsGrid" class="ag-theme-alpine"></div>
      </div>
    </div>
  {% else %}
    <div class="alert alert-warning" role="alert">
      No record found.
    </div>
  {% endif %}
</div>
  
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- ag-Grid JS -->
<script src="https://unpkg.com/ag-grid-community@26.2.0/dist/ag-grid-community.min.noStyle.js"></script>
<script>
  // Checkbox filtering for detail table.
  $(document).ready(function(){
    $('#filterValues').change(function(){
      if ($(this).is(':checked')) {
        $('#detailTable .detail-row').each(function(){
          var cellText = $(this).find('.value-cell').text().trim();
          if(cellText === ""){
            $(this).hide();
          }
        });
      } else {
        $('#detailTable .detail-row').show();
      }
    });
  });

  // Function to update the main detail section with new record data.
  function updateDetail(record) {
      var detailTable = document.getElementById("detailTable");
      var tbody = "";
      for (var key in record) {
          tbody += "<tr class='detail-row'><th style='width:30%;'>" + key + "</th><td class='value-cell'>" + record[key] + "</td></tr>";
      }
      detailTable.innerHTML = tbody;
      // Also update the asset class and group headings.
      document.getElementById("detailAssetClass").innerText = record.ASSET_CLASS;
      document.getElementById("detailAssetGroup").innerText = record.ASSET_GROUP;
  }

  document.addEventListener('DOMContentLoaded', function() {
    // Define columns for version grid (only APPLIED_DATE visible; key fields hidden).
    var versionColumnDefs = [
      { headerName: "APPLIED_DATE", field: "APPLIED_DATE", sortable: true, filter: true, width: 150 },
      { headerName: "FIGI", field: "FIGI", hide: true },
      { headerName: "CUSIP", field: "CUSIP", hide: true },
      { headerName: "SEDOL", field: "SEDOL", hide: true },
      { headerName: "ISIN", field: "ISIN", hide: true },
      { headerName: "COMPANY_NAME", field: "COMPANY_NAME", hide: true },
      { headerName: "CURRENCY", field: "CURRENCY", hide: true },
      { headerName: "ASSET_CLASS", field: "ASSET_CLASS", hide: true },
      { headerName: "ASSET_GROUP", field: "ASSET_GROUP", hide: true }
    ];

    var versionGridOptions = {
      columnDefs: versionColumnDefs,
      rowData: null,
      pagination: true,
      paginationPageSize: 25,
      onRowClicked: function(event) {
          // Build a query string from the version's data.
          var params = {
              APPLIED_DATE: event.data.APPLIED_DATE,
              FIGI: event.data.FIGI,
              CUSIP: event.data.CUSIP,
              SEDOL: event.data.SEDOL,
              ISIN: event.data.ISIN,
              COMPANY_NAME: event.data.COMPANY_NAME,
              CURRENCY: event.data.CURRENCY,
              ASSET_CLASS: event.data.ASSET_CLASS,
              ASSET_GROUP: event.data.ASSET_GROUP
          };
          var queryString = Object.keys(params).map(function(key) {
              return encodeURIComponent(key) + '=' + encodeURIComponent(params[key]);
          }).join('&');
          // Instead of opening a new tab, fetch the detail JSON and update the page.
          fetch("/security_detail_json?" + queryString)
            .then(response => response.json())
            .then(data => {
                updateDetail(data);
            })
            .catch(error => console.error("Error fetching version detail:", error));
      }
    };

    var gridDiv = document.getElementById("versionsGrid");
    new agGrid.Grid(gridDiv, versionGridOptions);

    // Build query string from the current record's key fields to load version history.
    var params = {
      FIGI: "{{ record.FIGI }}",
      CUSIP: "{{ record.CUSIP }}",
      SEDOL: "{{ record.SEDOL }}",
      ISIN: "{{ record.ISIN }}",
      COMPANY_NAME: "{{ record.COMPANY_NAME }}",
      CURRENCY: "{{ record.CURRENCY }}",
      ASSET_CLASS: "{{ record.ASSET_CLASS }}",
      ASSET_GROUP: "{{ record.ASSET_GROUP }}"
    };
    var queryString = Object.keys(params).map(function(key) {
      return encodeURIComponent(key) + '=' + encodeURIComponent(params[key]);
    }).join('&');

    fetch("/security_versions?" + queryString)
      .then(response => response.json())
      .then(data => versionGridOptions.api.setRowData(data))
      .catch(error => console.error("Error fetching version history:", error));
  });
</script>
</body>
</html>